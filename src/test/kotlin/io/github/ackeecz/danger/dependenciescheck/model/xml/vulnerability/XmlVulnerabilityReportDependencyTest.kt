@file:Suppress("MaximumLineLength")

package io.github.ackeecz.danger.dependenciescheck.model.xml.vulnerability

import io.github.ackeecz.danger.dependenciescheck.model.ArtifactId
import io.github.ackeecz.danger.dependenciescheck.model.DependencyName
import io.github.ackeecz.danger.dependenciescheck.model.GroupId
import io.github.ackeecz.danger.dependenciescheck.model.Version
import io.kotest.assertions.throwables.shouldThrow
import io.kotest.core.spec.style.FunSpec
import io.kotest.matchers.shouldBe

internal class XmlVulnerabilityReportDependencyTest : FunSpec({

    test("parse cardview-1.0.0.aar") {
        val expected = DependencyName(
            groupId = GroupId("androidx.cardview"),
            artifactId = ArtifactId("cardview"),
            version = Version("1.0.0"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "cardview-1.0.0.aar",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.cardview/cardview/1.0.0/158dbc2e2bc502815821191b04446b8f663c1874/cardview-1.0.0.aar",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse emoji2-1.2.0.aar: repackaged.jar") {
        val expected = DependencyName(
            groupId = GroupId("androidx.emoji2"),
            artifactId = ArtifactId("emoji2"),
            version = Version("1.2.0"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "emoji2-1.2.0.aar: repackaged.jar",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.emoji2/emoji2/1.2.0/2c95c9aa87788e4d9ce692ecfc961db004e57480/emoji2-1.2.0.aar/libs/repackaged.jar",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse cardview-1.0.0-rc01.aar") {
        val expected = DependencyName(
            groupId = GroupId("androidx.cardview"),
            artifactId = ArtifactId("cardview"),
            version = Version("1.0.0-rc01"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "cardview-1.0.0-rc01.aar",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.cardview/cardview/1.0.0-rc01/158dbc2e2bc502815821191b04446b8f663c1874/cardview-1.0.0-rc01.aar",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse emoji2-1.2.0-rc01.aar: repackaged.jar") {
        val expected = DependencyName(
            groupId = GroupId("androidx.emoji2"),
            artifactId = ArtifactId("emoji2"),
            version = Version("1.2.0-rc01"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "emoji2-1.2.0-rc01.aar: repackaged.jar",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.emoji2/emoji2/1.2.0-rc01/2c95c9aa87788e4d9ce692ecfc961db004e57480/emoji2-1.2.0-rc01.aar/libs/repackaged.jar",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse emoji2-views-helper-1.2.0.aar") {
        val expected = DependencyName(
            groupId = GroupId("androidx.emoji2"),
            artifactId = ArtifactId("emoji2-views-helper"),
            version = Version("1.2.0"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "emoji2-views-helper-1.2.0.aar",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.emoji2/emoji2-views-helper/1.2.0/4a22802fc9e88ad232522f04a35d1fdc3e5b4df0/emoji2-views-helper-1.2.0.aar",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse annotation-experimental-1.3.0.aar: lint.jar") {
        val expected = DependencyName(
            groupId = GroupId("androidx.annotation"),
            artifactId = ArtifactId("annotation-experimental"),
            version = Version("1.3.0"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "annotation-experimental-1.3.0.aar: lint.jar",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.annotation/annotation-experimental/1.3.0/5087c6f545117dcd474e69e1a93cacec9d7334af/annotation-experimental-1.3.0.aar/lint.jar",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse kotlin-compiler-embeddable-1.9.10-rc01.jar: jansi.dll") {
        val expected = DependencyName(
            groupId = GroupId("org.jetbrains.kotlin"),
            artifactId = ArtifactId("kotlin-compiler-embeddable"),
            version = Version("1.9.10-rc01"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "kotlin-compiler-embeddable-1.9.10-rc01.jar: jansi.dll",
            filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/org.jetbrains.kotlin/kotlin-compiler-embeddable/1.9.10-rc01/57ca1b0823ae3ecb451a97e1f8e6de0b19ea5294/kotlin-compiler-embeddable-1.9.10-rc01.jar/META-INF/native/windows32/jansi.dll",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("parse datastore-preferences-core-1.0.0.jar (shaded: com.google.protobuf:protobuf-javalite:3.10.0)") {
        val expected = DependencyName(
            groupId = GroupId("androidx.datastore"),
            artifactId = ArtifactId("datastore-preferences-core"),
            version = Version("1.0.0"),
        )

        val actual = XmlVulnerabilityReportDependency(
            fileName = "datastore-preferences-core-1.0.0.jar (shaded: com.google.protobuf:protobuf-javalite:3.10.0)",
            filePath = "/gradle/caches/modules-2/files-2.1/androidx.datastore/datastore-preferences-core/1.0.0/403f64499b9a8994f5f7010329ddd1ee5c919ed5/datastore-preferences-core-1.0.0.jar/META-INF/maven/com.google.protobuf/protobuf-javalite/pom.xml",
        ).toVulnerableDependency()

        actual.name shouldBe expected
    }

    test("fail parsing for unknown file name separator") {
        shouldThrow<UnsupportedSeparatorException> {
            XmlVulnerabilityReportDependency(
                fileName = "annotation-experimental-1.3.0.aar? lint.jar",
                filePath = "/Users/janmottl/.gradle/caches/modules-2/files-2.1/androidx.annotation/annotation-experimental/1.3.0/5087c6f545117dcd474e69e1a93cacec9d7334af/annotation-experimental-1.3.0.aar/lint.jar",
            )
        }
    }
})
